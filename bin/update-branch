#!/bin/sh
#
# Updates the current branch, by merging the branches specified
# as dependencies
#
# SPDX-License-Identifier: Apache-2.0
# Copyright 2020 Christian Kohlschuetter -- see NOTICE file

cd "$(dirname $0)/.."

prefix=
[ -n "$1" ] && git fetch "$1" && prefix="$1"/

set -e

IFS=$'\n'
for file in $(ls -1 -t -r dependencies); do
  branch=${file// //}
  if [ -n "$prefix" ]; then
    prefixedBranch="$prefix$branch"
    git rev-parse --verify --quiet "$prefixedBranch" >/dev/null && branch="$prefixedBranch"
  else
    # Branch not found locally -- try "upstream"
    git rev-parse --verify --quiet "$branch" >/dev/null || branch="upstream/"$branch
  fi

  (set -x ; git merge --no-ff "$branch" )
done
